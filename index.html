import 'dart:math';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart'; // Clipboard

void main() {
  runApp(const MyApp());
}

class MyApp extends StatelessWidget {
  const MyApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'ä½ å–œæ¬¢å–µå—',
      theme: ThemeData.dark(),
      home: const TerminalPage(),
    );
  }
}

class TerminalPage extends StatefulWidget {
  const TerminalPage({super.key});

  @override
  State<TerminalPage> createState() => _TerminalPageState();
}

class _TerminalPageState extends State<TerminalPage> {
  final TextEditingController _controller = TextEditingController();
  final ScrollController _scrollController = ScrollController();
  String log = "äººç”ŸçœŸæ˜¯å–µå–µåˆå’ªå’ª..";
  bool keyAccepted = false;
  String key = "";

  static const String MAGIC = "\u200b\u200c\u200d\ufeff";
  static const List<String> ZERO_WIDTH = ["\u200b", "\u200c", "\u200d", "\ufeff"];
  static const String VISIBLE = "å–µ";

  void appendLog(String text) {
    setState(() {
      log += "\n$text";
    });
    // æ»šåŠ¨åˆ°åº•éƒ¨
    WidgetsBinding.instance.addPostFrameCallback((_) {
      if (_scrollController.hasClients) {
        _scrollController.jumpTo(_scrollController.position.maxScrollExtent);
      }
    });
  }

  String intToZW(int n, [int length = 10]) {
    String result = "";
    for (int i = 0; i < length; i++) {
      result = ZERO_WIDTH[n % 4] + result;
      n ~/= 4;
    }
    return result;
  }

  int zwToInt(String zwStr) {
    int n = 0;
    for (var ch in zwStr.split('')) {
      n = n * 4 + ZERO_WIDTH.indexOf(ch);
    }
    return n;
  }

  List<int> generateKeyShifts(String key, int length) {
    List<int> codes = key.codeUnits;
    return List.generate(length, (i) => codes[i % codes.length]);
  }

  void handleInput(String cmd) async {
    appendLog("âœ $cmd");
    if (!keyAccepted) {
      if (cmd.trim() == "meow") {
        key = "meow";
        keyAccepted = true;
        appendLog("âœ… meowæ­£ç¡®~~ï¼Œå¼€å§‹å–µå–µå–µå–µï¼");
      } else {
        appendLog("âŒ meowé”™è¯¯ï¼ˆè¯·è¾“å…¥ä½ çš„å–µï¼‰");
      }
      return;
    }

    if (cmd.startsWith(MAGIC)) {
      final input = cmd.substring(MAGIC.length);
      final parts = input.split(VISIBLE).skip(1).toList();
      final shifts = generateKeyShifts(key, parts.length);
      String result = "";
      for (int i = 0; i < parts.length; i++) {
        if (parts[i].length < 10) continue;
        final zw = parts[i].substring(0, 10);
        final code = zwToInt(zw);
        result += String.fromCharCode(code - shifts[i]);
      }
      appendLog("ğŸ”“ è§£å–µç»“æœï¼š\n$result");
    } else {
      final shifts = generateKeyShifts(key, cmd.length);
      String result = MAGIC;
      for (int i = 0; i < cmd.length; i++) {
        final shifted = cmd.codeUnitAt(i) + shifts[i];
        final zw = intToZW(shifted);
        result += VISIBLE + zw;
      }
      // è·¨å¹³å° Clipboard
      try {
        await Clipboard.setData(ClipboardData(text: result));
        appendLog("ğŸ” åŠ meowæˆåŠŸï¼Œç»“æœå·²å¤åˆ¶ï¼");
      } catch (e) {
        appendLog("âš ï¸ åŠ meowæˆåŠŸä½†å¤åˆ¶å¤±è´¥: $e\n$result");
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Container(
        padding: const EdgeInsets.all(8),
        color: Colors.black,
        child: Column(
          children: [
            Expanded(
              child: SingleChildScrollView(
                controller: _scrollController,
                child: Text(
                  log,
                  style: const TextStyle(color: Color(0xff33ff33), fontFamily: 'monospace'),
                ),
              ),
            ),
            Row(
              children: [
                const Text("âœ ", style: TextStyle(color: Color(0xff33ff33), fontFamily: 'monospace')),
                Expanded(
                  child: TextField(
                    controller: _controller,
                    style: const TextStyle(color: Color(0xff33ff33), fontFamily: 'monospace'),
                    decoration: const InputDecoration(
                      border: InputBorder.none,
                      isDense: true,
                      contentPadding: EdgeInsets.symmetric(vertical: 8),
                    ),
                    onSubmitted: (value) {
                      if (value.trim().isEmpty) return;
                      _controller.clear();
                      try {
                        handleInput(value.trim());
                      } catch (e) {
                        appendLog("â— å‡ºé”™äº†: $e");
                      }
                    },
                  ),
                ),
              ],
            )
          ],
        ),
      ),
    );
  }
}
